# SLAM-Share Clean Ubuntu 20.04 Build
# Fast build using proven Dockerfile.base approach with NVIDIA runtime support
FROM ubuntu:20.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    wget \
    curl \
    pkg-config \
    software-properties-common \
    lsb-release \
    gnupg2 \
    ca-certificates \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install ROS Noetic
RUN echo "deb http://packages.ros.org/ros/ubuntu focal main" > /etc/apt/sources.list.d/ros-latest.list && \
    apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654 && \
    apt-get update && \
    apt-get install -y \
        ros-noetic-desktop-full \
        ros-noetic-roscpp \
        ros-noetic-tf \
        ros-noetic-cv-bridge \
        ros-noetic-image-transport \
        ros-noetic-sensor-msgs \
        python3-rosdep \
        python3-rosinstall \
        python3-rosinstall-generator \
        python3-wstool \
        python3-catkin-tools && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Initialize rosdep
RUN rosdep init && rosdep update

# Setup ROS environment
RUN echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc
ENV ROS_MASTER_URI=http://localhost:11311
ENV ROS_HOSTNAME=localhost
ENV ROS_DISTRO=noetic

# Install OpenGL and X11 libraries for visualization (NVIDIA runtime compatible)
RUN apt-get update && apt-get install -y \
    # OpenGL libraries
    libgl1-mesa-glx \
    libgl1-mesa-dev \
    libglu1-mesa-dev \
    libegl1-mesa \
    libgles2-mesa \
    # X11 and OpenGL development
    libx11-dev libxext-dev libxrender-dev \
    libxinerama-dev libxi-dev libxrandr-dev \
    libxcursor-dev libxdamage-dev libxcomposite-dev \
    libxtst-dev libxss-dev libxft-dev \
    # OpenGL utilities
    mesa-utils \
    # GTK for OpenCV
    libgtk-3-dev libgtk2.0-dev \
    # Additional OpenGL libraries
    libglew-dev \
    freeglut3-dev \
    libglfw3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install SLAM-Share dependencies
RUN apt-get update && apt-get install -y \
    libeigen3-dev \
    libboost-all-dev \
    libssl-dev \
    libpng-dev \
    libjpeg-dev \
    libtiff-dev \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    && rm -rf /var/lib/apt/lists/*

# Build OpenCV 4.10.0 from source (EXACT same config as successful Dockerfile.base)
RUN cd /tmp && \
    wget -O opencv.zip https://github.com/opencv/opencv/archive/4.10.0.zip && \
    wget -O opencv_contrib.zip https://github.com/opencv/opencv_contrib/archive/4.10.0.zip && \
    unzip opencv.zip && unzip opencv_contrib.zip && \
    cd opencv-4.10.0 && \
    mkdir build && cd build && \
    cmake -D CMAKE_BUILD_TYPE=RELEASE \
          -D CMAKE_INSTALL_PREFIX=/usr/local \
          -D OPENCV_EXTRA_MODULES_PATH=/tmp/opencv_contrib-4.10.0/modules \
          -D OPENCV_ENABLE_NONFREE=ON \
          -D BUILD_EXAMPLES=OFF \
          -D BUILD_TESTS=OFF \
          -D BUILD_PERF_TESTS=OFF \
          -D WITH_TBB=ON \
          -D WITH_V4L=ON \
          -D WITH_QT=OFF \
          -D WITH_GTK=ON \
          -D WITH_OPENGL=ON \
          -D OPENCV_GENERATE_PKGCONFIG=YES \
          .. && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    rm -rf /tmp/opencv*

# Verify OpenCV 4.10 installation
RUN echo "=== OpenCV Version Check ===" && \
    pkg-config --modversion opencv4 && \
    echo "=== Available OpenCV Libraries ===" && \
    ldconfig -p | grep opencv | head -5

# Build Pangolin from source (use v0.6 for Ubuntu 20.04 compatibility)
RUN echo "=== Building Pangolin from Source ===" && \
    cd /tmp && \
    git clone --branch v0.6 --depth 1 https://github.com/stevenlovegrove/Pangolin.git && \
    cd Pangolin && \
    mkdir build && cd build && \
    cmake .. -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_INSTALL_PREFIX=/usr/local \
             -DBUILD_EXAMPLES=OFF \
             -DCMAKE_CXX_STANDARD=14 && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    cd / && rm -rf /tmp/Pangolin && \
    echo "=========================="

# Set compilation flags (same as successful builds)
ENV CXXFLAGS="-O3 -march=native -Wno-deprecated-declarations -Wno-maybe-uninitialized -Wno-reorder -Wno-sign-compare -Wno-format-overflow -Wno-error -fpermissive"
ENV CMAKE_C_FLAGS="-Wall -O3 -march=native -Wno-deprecated-declarations -Wno-maybe-uninitialized -Wno-format-overflow -Wno-error"
ENV CMAKE_CXX_FLAGS="-Wall -O3 -march=native -Wno-deprecated-declarations -Wno-maybe-uninitialized -Wno-reorder -Wno-sign-compare -Wno-format-overflow -Wno-error -fpermissive"

# Copy SLAM-Share source code from local directory
COPY . /slam-share/

# Extract vocabulary (as per owner's build.sh)
RUN echo "=== Extracting ORB Vocabulary ===" && \
    cd /slam-share/Vocabulary && \
    tar -xf ORBvoc.txt.tar.gz && \
    echo "Vocabulary extracted successfully" && \
    echo "=========================="

# Build dependencies first (same as successful original build)
WORKDIR /slam-share

# Build DBoW2
RUN echo "=== Building DBoW2 ===" && \
    cd Thirdparty/DBoW2 && \
    mkdir -p build && cd build && \
    cmake .. -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_C_FLAGS="$CMAKE_C_FLAGS" \
             -DCMAKE_CXX_FLAGS="$CMAKE_CXX_FLAGS" && \
    make -j$(nproc) && \
    echo "DBoW2 built successfully"

# Build g2o
RUN echo "=== Building g2o ===" && \
    cd Thirdparty/g2o && \
    mkdir -p build && cd build && \
    cmake .. -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_C_FLAGS="$CMAKE_C_FLAGS" \
             -DCMAKE_CXX_FLAGS="$CMAKE_CXX_FLAGS" && \
    make -j$(nproc) && \
    echo "g2o built successfully"

# Build main SLAM-Share library
RUN echo "=== Building SLAM-Share Main Library ===" && \
    cd /slam-share && \
    mkdir -p build && cd build && \
    cmake .. -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_CXX_STANDARD=14 \
             -DCMAKE_C_FLAGS="$CMAKE_C_FLAGS" \
             -DCMAKE_CXX_FLAGS="$CMAKE_CXX_FLAGS" && \
    make -j$(nproc) && \
    echo "SLAM-Share library built successfully"

# Build ROS nodes with Noetic
RUN /bin/bash -c "source /opt/ros/noetic/setup.bash && \
    export ROS_PACKAGE_PATH=/slam-share/Examples/ROS/ORB_SLAM3:\$ROS_PACKAGE_PATH && \
    cd Examples/ROS/ORB_SLAM3 && \
    mkdir -p build && cd build && \
    cmake .. -DROS_BUILD_TYPE=Release \
             -DCMAKE_C_FLAGS=\"\$CMAKE_C_FLAGS\" \
             -DCMAKE_CXX_FLAGS=\"\$CMAKE_CXX_FLAGS\" && \
    make -j\$(nproc)"

# Set NVIDIA environment variables for runtime GPU access
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=graphics,utility,compute
ENV QT_X11_NO_MITSHM=1

# Set library paths
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH

# Copy server configuration files
RUN mkdir -p /slam-share-ros-server/config && \
    cp /slam-share/Examples/ROS/ORB_SLAM3/Asus.yaml /slam-share-ros-server/config/ && \
    cp /slam-share/Examples/Monocular/EuRoC.yaml /slam-share-ros-server/config/ && \
    echo "Available config files:" && \
    ls -la /slam-share-ros-server/config/

# Create optimized startup script
RUN echo '#!/bin/bash' > /start-slam-ubuntu.sh && \
    echo 'echo "=== SLAM-Share Ubuntu GPU Server ==="' >> /start-slam-ubuntu.sh && \
    echo 'source /opt/ros/noetic/setup.bash' >> /start-slam-ubuntu.sh && \
    echo 'export ROS_MASTER_URI=http://slam-server:11311' >> /start-slam-ubuntu.sh && \
    echo 'export ROS_HOSTNAME=slam-server' >> /start-slam-ubuntu.sh && \
    echo 'export ROS_PACKAGE_PATH=/slam-share/Examples/ROS/ORB_SLAM3:$ROS_PACKAGE_PATH' >> /start-slam-ubuntu.sh && \
    echo 'export DISPLAY=$DISPLAY' >> /start-slam-ubuntu.sh && \
    echo 'echo "ðŸš€ Starting ROS Master..."' >> /start-slam-ubuntu.sh && \
    echo 'rosmaster --core -p 11311 &' >> /start-slam-ubuntu.sh && \
    echo 'sleep 15' >> /start-slam-ubuntu.sh && \
    echo 'echo "ðŸ–¥ï¸  OpenGL Info:"' >> /start-slam-ubuntu.sh && \
    echo 'glxinfo | head -10 || echo "OpenGL not available"' >> /start-slam-ubuntu.sh && \
    echo 'echo "ðŸŽ¯ Starting SLAM with GPU acceleration..."' >> /start-slam-ubuntu.sh && \
    echo 'cd /slam-share/Examples/ROS/ORB_SLAM3' >> /start-slam-ubuntu.sh && \
    echo 'rosrun ORB_SLAM3 Mono /slam-share/Vocabulary/ORBvoc.txt /slam-share-ros-server/config/Asus.yaml' >> /start-slam-ubuntu.sh && \
    chmod +x /start-slam-ubuntu.sh

WORKDIR /slam-share

# Apply permanent fixes at the very end (fast rebuild layer)
RUN echo "=== Installing Xvfb and applying fixes ===" && \
    # Install Xvfb for headless display
    apt-get update && apt-get install -y xvfb && rm -rf /var/lib/apt/lists/* && \
    # Fix shared memory allocation (10GB -> 64MB)
    sed -i 's/10737418240/67108864/g' /slam-share/src/System.cc && \
    # Disable viewer in ROS wrapper (true -> false)
    sed -i 's/MONOCULAR,true/MONOCULAR,false/' /slam-share/Examples/ROS/ORB_SLAM3/src/ros_mono.cc && \
    echo "Xvfb install and fixes applied successfully"

# Rebuild only the affected components (fast)
RUN echo "=== Rebuilding with fixes ===" && \
    cd /slam-share/build && \
    make -j$(nproc) && \
    cd /slam-share/Examples/ROS/ORB_SLAM3/build && \
    make -j$(nproc) && \
    echo "Rebuild complete"

CMD ["/start-slam-ubuntu.sh"]